<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Drive Control Panel</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/app.css">
    
    <link rel="stylesheet" href="css/pitchrollgauges.css">
    <!-- Bootstrap Icons for the question mark -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
</head>
<body>

<!-- Top Navbar and Nav Menu -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand" href="#">Dynamic Drive</a>
    </div>
</nav>

<div id="nav-placeholder"></div>

<script>
    // Load navigation HTML into the placeholder
    function loadNav() {
        fetch('nav.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('nav-placeholder').innerHTML = data;
            });
    }
    loadNav();
</script>


<!-- Main Content -->
<!-- Main Content -->
<div class="container my-4">
    <h3>Radar Example MPU Testing</h3>
    <p>Readings are taken every 0.5 seconds, averaged over a 5-second period, and the graph is refreshed at the end of each 5-second interval.
    
    <div>
      <canvas id="kt_chartjs_5" class="mh-400px"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      var ctx = document.getElementById('kt_chartjs_5');

      // Define colors
      var infoColor = 'rgba(54, 162, 235, 0.5)';
      var warningColor = 'rgba(255, 206, 86, 0.5)';

      // Initialize an empty data buffer to store sensor values
      let dataBuffer = {
        xAxis: [],
        yAxis: [],
      };

      // Mock data generation (replace this with actual sensor data)
      function collectData() {
        return {
          xAxis: Array.from({ length: 6 }, () => (Math.random() * 2 + 1).toFixed(2)),
          yAxis: Array.from({ length: 6 }, () => (Math.random() * 2 + 1).toFixed(2))
        };
      }

      // Chart labels
      const labels = ['X-Axis', 'Y-Axis', 'Z-Axis', 'Pitch', 'Roll', 'Yaw'];

      // Chart data
const data = {
    labels: ['X-Axis', 'Y-Axis', 'Z-Axis', 'Pitch', 'Roll', 'Yaw'],
    datasets: [
        {
            label: 'X-Axis Data',  // Renamed to reflect what the dataset represents
            data: [1.5, 1.6, 1.7, 1.4, 1.8, 1.2],  // Example data for the X-axis
            fill: true,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
        },
        {
            label: 'Y-Axis Data',  // Renamed to reflect what the dataset represents
            data: [1.2, 1.3, 1.6, 1.7, 1.3, 1.9],  // Example data for the Y-axis
            fill: true,
            backgroundColor: 'rgba(255, 206, 86, 0.2)',
            borderColor: 'rgba(255, 206, 86, 1)',
            pointBackgroundColor: 'rgba(255, 206, 86, 1)',
        }
    ]
};


      // Chart config
      const config = {
        type: 'radar',
        data: data,
        options: {
          elements: {
            line: {
              borderWidth: 3
            }
          },
          responsive: true,
        }
      };

      // Init ChartJS
      var myChart = new Chart(ctx, config);

      // Function to calculate the average of an array
      function averageArray(arr) {
        const sum = arr.reduce((acc, val) => acc.map((num, idx) => num + parseFloat(val[idx])), Array(arr[0].length).fill(0));
        return sum.map(val => (val / arr.length).toFixed(2));
      }

      // Collect data every 500ms
      setInterval(() => {
        const newData = collectData();

        // Store data in buffer
        dataBuffer.xAxis.push(newData.xAxis);
        dataBuffer.yAxis.push(newData.yAxis);

        // Ensure buffer only keeps the last 5 seconds of data (10 entries of 500ms)
        if (dataBuffer.xAxis.length > 10) {
          dataBuffer.xAxis.shift();
          dataBuffer.yAxis.shift();
        }
      }, 500);  // Collect every 500ms

      // Update chart every 5 seconds
      setInterval(() => {
        if (dataBuffer.xAxis.length > 0 && dataBuffer.yAxis.length > 0) {
          // Calculate the average of the data collected over the last 5 seconds
          const avgXAxis = averageArray(dataBuffer.xAxis);
          const avgYAxis = averageArray(dataBuffer.yAxis);

          // Update chart data
          myChart.data.datasets[0].data = avgXAxis;
          myChart.data.datasets[1].data = avgYAxis;

          // Refresh the chart
          myChart.update();

          // Clear buffer after updating
          dataBuffer.xAxis = [];
          dataBuffer.yAxis = [];
        }
      }, 5000);  // Update every 5 seconds

    </script>
</div>





<footer class="footer">
    <div class="container">
      <p class="mb-0">Savage Cat Solutions &copy;2020 - <span id="currentYear"></span></p>
    </div>
  </footer>
<!-- Bootstrap 5 JS and dependencies (Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<!-- script for the pitch/roll gauges -->
<script src="js/pitchrollgauges.js"></script>
<script>
    // Initialize all tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            trigger: 'click'
        })
    });

    function init(){
        getCurrentYearForCopy();
    }

    function getCurrentYearForCopy(){
        const d = new Date();
        let year = d.getFullYear();
        document.getElementById("currentYear").innerHTML = year;
    }

    // Functions to connect and disconnect from Bluetooth device
    function connectToESP32() {
        const macAddress = "24:DC:C3:46:5A:F6"; // Replace with your actual ESP32 MAC address
        console.log("Attempting to connect to macAddress: " + macAddress);
        alert("Attempting to connect to: " + macAddress);
        BluetoothInterface.connectToDevice(macAddress);
    }

    function sendDataToESP32(key, value) {
        console.log(key)
        console.log(value);
        console.log("Send button clicked");
        const data = JSON.stringify({ [key]: value });
        BluetoothInterface.sendData(data);
    }

    function disconnectFromESP32() {
        console.log("Disconnect button clicked");
        BluetoothInterface.disconnect();
    }

    function resetGyro() {
        const key = "mpureset";
        const value = 1;
        console.log("Reset Gyro button clicked");
        const data = JSON.stringify({ [key]: value });
        BluetoothInterface.sendData(data);
    }

    init();
</script>
</body>
</html>
